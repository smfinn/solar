---
title: "Expected Financial Outcomes of Residential Solar Projects in Iowa"
subtitle: "Simulation Final Project"
author: "Sean Finn"
date: "Due 12/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(gganimate)
library(egg)
theme_set(theme_bw())
```

```{r create.function.static.inputs, include=F}
solar.project <- function(cash.paid, # The amount of cash put down directly on the investment (same as a loan downpayment)
                          invest.loan, # The amount contributed to the investment through a bank
                          loan.apr, # The annual interest rate on the loan
                          loan.length, # The length of the loan in years
                          price.per.panel, # The cost of the investment per panel
                          num.panels, # The number of panels installed
                          kWh.per.panel = 45, # The expected monthly amount of kWh generated by each solar panel 
                          install.fees, # The total one-time start-up fees for installing panels
                          yearly.costs = 400, # The expected yearly maintenance cost associated with all the panels
                          prop.effloss = 0.005, # The annual percent reduction in efficiency of the panels
                          prob.damage = 0.01, # The probability of damage occurring to the panels
                          repair.cost = 2000, # The expected cost to repair the panels after damage occurs
                          start.ppkWh = 0.0883, # The expected price per kilowatt hour charged by energy provider
                          monthly.usage = 900, # The expected monthly energy usage in kWh
                          ppkWh.change = 0.003, # The expected annual change in ppkWh charged
                          num.years # The number of years for which to run the simulation
                          ) {
    
    # Checks for proper input
    if((cash.paid + invest.loan) != ((price.per.panel*num.panels) + install.fees)) stop("Cost inputs do not add up") 
    if(loan.apr > 0.99) stop("Enter loan APR in decimal percent format") 
    if(loan.length %% 1 != 0) stop("Enter loan length in whole years")
    if(prop.effloss > 0.99) stop("Enter estimate for annual efficiency loss in decimal percent format") 
    if(prob.damage > 0.99) stop("Enter probability of damage in decimal percent format") 
    if(ppkWh.change > 0.99) stop("Enter change in price per kWh in decimal percent format") 
    
    # Create some variables from inputs
    monthly.rate <- (loan.apr / 12)
    npmts <- (loan.length * 12)
    if(invest.loan > 0) {
        total.monthly.payment <- invest.loan * ((monthly.rate * 
            ((1 + monthly.rate)^npmts)) / (((1 + monthly.rate)^npmts) - 1))
    } else{ 
        total.monthly.payment <- 0
    }
    
    # Initialize vectors for storing output
    years <- seq(0, num.years)
    panels.prop.total.energy <- rep(NA, num.years+1)
    panel.eff.capacity <- rep(NA, num.years+1)
    ppkWh <- rep(NA, num.years+1)
    gross.principal.paid <- rep(NA, num.years+1)
    annual.principal.paid <- rep(NA, num.years+1)
    gross.costs <- rep(NA, num.years+1)
    annual.costs <- rep(NA, num.years+1)
    gross.energy.costs <- rep(NA, num.years+1)
    annual.energy.costs <- rep(NA, num.years+1)
    gross.amount.saved <- rep(NA, num.years+1)
    annual.amount.saved <- rep(NA, num.years+1)
    gross.interest <- rep(NA, num.years+1)
    annual.interest <- rep(NA, num.years+1)
    loan.balance <- rep(NA, num.years+1)
    net <- rep(NA, num.years+1)
    ROI <- rep(NA, num.years+1)
    
    # Start-up costs
    gross.costs[1] <- cash.paid
    annual.costs[1] <- cash.paid
    annual.principal.paid[1] <- 0
    gross.principal.paid[1] <- 0
    annual.interest[1] <- 0
    gross.interest[1] <- 0

    # Time-of-purchase values
    panels.prop.total.energy[1] <- 0
    panel.eff.capacity[1] <- 1
    ppkWh[1] <- start.ppkWh
    annual.energy.costs[1] <- 0 
    annual.amount.saved[1] <- 0
    gross.energy.costs[1] <- 0 
    gross.amount.saved[1] <- 0
    loan.balance[1] <- invest.loan
    net[1] <- -(gross.costs[1] + loan.balance[1])
    ROI[1] <- (gross.amount.saved[1] - gross.costs[1] - loan.balance[1]) / 
                (gross.costs[1] + loan.balance[1])

  # Annual changes
  for(Y in 2:(num.years+1)) {
        
    # Update monthly payment if remaining loan balance is under monthly payment
    if(loan.balance[Y-1] > (total.monthly.payment*12)) {
        total.monthly.payment <- invest.loan * ((monthly.rate * 
        ((1 + monthly.rate)^npmts)) / (((1 + monthly.rate)^npmts) - 1))
    } else if((loan.balance[Y-1] < (total.monthly.payment*12)) & 
              (loan.balance[Y-1] > 0)) {
        total.monthly.payment <- loan.balance[Y-1]/12
    } else {
        total.monthly.payment <- 0
    }
    
    # Calculate new price per kWh based on annual percent change in price
    ppkWh[Y] <- ppkWh[Y-1] * (1 + ppkWh.change)
    
    # Calculate new panel production capacity based on percent efficiency loss
    panel.eff.capacity[Y] <- panel.eff.capacity[Y-1] * (1 - prop.effloss)
    
    # Calculate the proportion of energy usage contributed by panels
    panels.prop.total.energy[Y] <- 
        (kWh.per.panel * num.panels * panel.eff.capacity[Y]) / monthly.usage
    
    # Update annual and gross out-of-pocket costs for solar panels
    annual.costs[Y] <- round(yearly.costs + (repair.cost*prob.damage) + 
                       (total.monthly.payment*12))
    gross.costs[Y] <- gross.costs[Y-1] + annual.costs[Y]
    
    # Update annual and gross energy costs paid to utility provider
    annual.energy.costs[Y] <- round(ppkWh[Y] * monthly.usage * 
        (1 - panels.prop.total.energy[Y]) * 12)
    gross.energy.costs[Y] <- gross.energy.costs[Y-1] + annual.energy.costs[Y]
    
    # Update annual and gross amount saved on utility bills by producing solar energy
    annual.amount.saved[Y] <- round((ppkWh[Y] * monthly.usage * 12) - annual.energy.costs[Y])
    gross.amount.saved[Y] <- gross.amount.saved[Y-1] + annual.amount.saved[Y]
    
    # Update annual and gross amount of interest paid on loan
    annual.interest[Y] <- round((monthly.rate * loan.balance[Y-1]) * 12)
    gross.interest[Y] <- gross.interest[Y-1] + annual.interest[Y]
    
    # Update annual and gross amount of principal paid toward loan
    annual.principal.paid[Y] <- round((total.monthly.payment * 12) - annual.interest[Y])
    gross.principal.paid[Y] <- gross.principal.paid[Y-1] + annual.principal.paid[Y]
    
    # Update running loan balance by subtracting each year's principal paid
    loan.balance[Y] <- round(loan.balance[Y-1] - annual.principal.paid[Y], 0)
    
    # Update net costs based on gross costs, loan balance, and gross amount saved
    net[Y] <- gross.amount.saved[Y] - (gross.costs[Y] + loan.balance[Y])
    
    # Calculate running return on investment
    ROI[Y] <- (gross.amount.saved[Y] - (gross.costs[Y] + loan.balance[Y])) / 
                    (gross.costs[Y] + loan.balance[Y])
    }
    
    out <- as.data.frame(cbind(years, net, ROI, ppkWh, panel.eff.capacity, 
            panels.prop.total.energy, annual.costs, gross.costs, 
            annual.energy.costs, gross.energy.costs, annual.amount.saved, 
            gross.amount.saved, annual.interest, gross.interest, 
            annual.principal.paid, gross.principal.paid, loan.balance))
    return(out)
    
}


```

```{r simulate.project, include=F}
cash.paid = 2000
invest.loan = 10000
loan.apr = .032
loan.length = 5
price.per.panel = 400
num.panels = 20
kWh.per.panel = 45
install.fees = 4000
yearly.costs = 50
prop.effloss = 0.005
prob.damage = 0.001
repair.cost = 10000
start.ppkWh = 0.1
monthly.usage = 900
ppkWh.change = 0.005
num.years = 20

test <- solar.project(cash.paid = cash.paid, invest.loan = invest.loan,  
              loan.apr = loan.apr, loan.length = loan.length, 
              price.per.panel = price.per.panel, 
              num.panels = num.panels, kWh.per.panel = kWh.per.panel, 
              install.fees = install.fees, yearly.costs = yearly.costs, 
              prop.effloss = prop.effloss, prob.damage = prob.damage, 
              repair.cost = repair.cost, start.ppkWh = start.ppkWh, 
              monthly.usage = monthly.usage, ppkWh.change = ppkWh.change, 
              num.years = num.years)

# Test using all default values, loan only
test1 <- solar.project(cash.paid = 0, invest.loan = 10000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 25,
                       install.fees = 3750, num.years = 20)

# Test using all default values, cash only
test2 <- solar.project(cash.paid = 10000, invest.loan = 0, loan.apr = 0,
                       loan.length = 0, price.per.panel = 250, num.panels = 25,
                       install.fees = 3750, num.years = 20)

# Default values, except don't pay for annual inspection/cleaning
test3 <- solar.project(cash.paid = 8250, invest.loan = 0, loan.apr = 0,
                       loan.length = 0, price.per.panel = 250, num.panels = 25,
                       yearly.costs = 0, install.fees = 2000, num.years = 15)
```

```{r create.function.distributed.inputs, include=F}
solar.project2 <- function(cash.paid, 
                          invest.loan,
                          loan.apr, 
                          loan.length, 
                          price.per.panel, 
                          num.panels, 
                          kWh.per.panel = 45,
                          install.fees, 
                          yearly.costs = rnorm(num.years+1, mean=400, sd=50), 
                          prop.effloss = rnorm(num.years+1, mean=0.0065, sd=0.001),
                          prob.damage = rbinom(num.years+1, size=1, prob=0.005),
                          repair.cost = rexp(num.years+1, rate=0.0005),
                          start.ppkWh = 0.0883,
                          monthly.usage = rnorm(num.years+1, mean=900, sd=200), 
                          ppkWh.change = rexp(num.years+1, rate=50), 
                          num.years) {
    
    # Checks for proper input
    if((cash.paid + invest.loan) != ((price.per.panel*num.panels) + install.fees)) stop("Cost inputs do not add up") 
    if(loan.apr > 0.99) stop("Enter loan APR in decimal percent format") 
    if(loan.length %% 1 != 0) stop("Enter loan length in whole years")
    if(prop.effloss[1] > 0.99) stop("Enter estimate for annual efficiency loss in decimal percent format") 
    if(ppkWh.change[1] > 0.99) stop("Enter change in price per kWh in decimal percent format") 
    
    # Create some variables from inputs
    monthly.rate <- (loan.apr / 12)
    npmts <- (loan.length * 12)
    if(invest.loan > 0) {
        total.monthly.payment <- invest.loan * ((monthly.rate * 
            ((1 + monthly.rate)^npmts)) / (((1 + monthly.rate)^npmts) - 1))
    } else{ 
        total.monthly.payment <- 0
    }
    
    # Initialize vectors for storing output
    years <- seq(0, num.years)
    panels.prop.total.energy <- rep(NA, num.years+1)
    panel.eff.capacity <- rep(NA, num.years+1)
    ppkWh <- rep(NA, num.years+1)
    gross.principal.paid <- rep(NA, num.years+1)
    annual.principal.paid <- rep(NA, num.years+1)
    gross.costs <- rep(NA, num.years+1)
    annual.costs <- rep(NA, num.years+1)
    gross.energy.costs <- rep(NA, num.years+1)
    annual.energy.costs <- rep(NA, num.years+1)
    gross.amount.saved <- rep(NA, num.years+1)
    annual.amount.saved <- rep(NA, num.years+1)
    gross.interest <- rep(NA, num.years+1)
    annual.interest <- rep(NA, num.years+1)
    loan.balance <- rep(NA, num.years+1)
    net <- rep(NA, num.years+1)
    ROI <- rep(NA, num.years+1)
    
    # Start-up costs
    gross.costs[1] <- cash.paid
    annual.costs[1] <- cash.paid
    annual.principal.paid[1] <- 0
    gross.principal.paid[1] <- 0
    annual.interest[1] <- 0
    gross.interest[1] <- 0

    # Time-of-purchase values
    panels.prop.total.energy[1] <- 0
    panel.eff.capacity[1] <- 1
    ppkWh[1] <- start.ppkWh
    annual.energy.costs[1] <- 0 
    annual.amount.saved[1] <- 0
    gross.energy.costs[1] <- 0 
    gross.amount.saved[1] <- 0
    loan.balance[1] <- invest.loan
    net[1] <- -(gross.costs[1] + loan.balance[1])
    ROI[1] <- (gross.amount.saved[1] - gross.costs[1] - loan.balance[1]) / 
                (gross.costs[1] + loan.balance[1])

  # Annual changes
  for(Y in 2:(num.years+1)) {
        
    # Update monthly payment if remaining loan balance is under monthly payment
    if(loan.balance[Y-1] > (total.monthly.payment*12)) {
        total.monthly.payment <- invest.loan * ((monthly.rate * 
        ((1 + monthly.rate)^npmts)) / (((1 + monthly.rate)^npmts) - 1))
    } else if((loan.balance[Y-1] < (total.monthly.payment*12)) & 
              (loan.balance[Y-1] > 0)) {
        total.monthly.payment <- loan.balance[Y-1]/12
    } else {
        total.monthly.payment <- 0
    }
    
    # Calculate new price per kWh based on annual percent change in price
    ppkWh[Y] <- ppkWh[Y-1] * (1 + ppkWh.change[Y])
    
    # Calculate new panel production capacity based on percent efficiency loss
    panel.eff.capacity[Y] <- panel.eff.capacity[Y-1] * (1 - prop.effloss[Y])
    
    # Calculate the proportion of energy usage contributed by panels
    panels.prop.total.energy[Y] <- 
        (kWh.per.panel * num.panels * panel.eff.capacity[Y]) / monthly.usage[Y]
    
    # Update annual and gross out-of-pocket costs for solar panels
    annual.costs[Y] <- round(yearly.costs[Y] + (repair.cost[Y]*prob.damage[Y]) + 
                       (total.monthly.payment*12))
    gross.costs[Y] <- gross.costs[Y-1] + annual.costs[Y]
    
    # Update annual and gross energy costs paid to utility provider
    annual.energy.costs[Y] <- round(ppkWh[Y] * monthly.usage[Y] * 
        (1 - panels.prop.total.energy[Y]) * 12)
    gross.energy.costs[Y] <- gross.energy.costs[Y-1] + annual.energy.costs[Y]
    
    # Update annual and gross amount saved on utility bills by producing solar energy
    annual.amount.saved[Y] <- round((ppkWh[Y] * monthly.usage[Y] * 12) - annual.energy.costs[Y])
    gross.amount.saved[Y] <- gross.amount.saved[Y-1] + annual.amount.saved[Y]
    
    # Update annual and gross amount of interest paid on loan
    annual.interest[Y] <- round((monthly.rate * loan.balance[Y-1]) * 12)
    gross.interest[Y] <- gross.interest[Y-1] + annual.interest[Y]
    
    # Update annual and gross amount of principal paid toward loan
    annual.principal.paid[Y] <- round((total.monthly.payment * 12) - annual.interest[Y])
    gross.principal.paid[Y] <- gross.principal.paid[Y-1] + annual.principal.paid[Y]
    
    # Update running loan balance by subtracting each year's principal paid
    loan.balance[Y] <- round(loan.balance[Y-1] - annual.principal.paid[Y], 0)
    
    # Update net costs based on gross costs, loan balance, and gross amount saved
    net[Y] <- gross.amount.saved[Y] - (gross.costs[Y] + loan.balance[Y])
    
    # Calculate running return on investment
    ROI[Y] <- (gross.amount.saved[Y] - (gross.costs[Y] + loan.balance[Y])) / 
                    (gross.costs[Y] + loan.balance[Y])
    }
    
    out <- as.data.frame(cbind(years, net, ROI, ppkWh, panel.eff.capacity, 
            panels.prop.total.energy, annual.costs, gross.costs, 
            annual.energy.costs, gross.energy.costs, annual.amount.saved, 
            gross.amount.saved, annual.interest, gross.interest, 
            annual.principal.paid, gross.principal.paid, loan.balance))
    return(out)
    
}


```

```{r distribution.function.tests, include=F}
# Test using all default values, loan only
test4 <- solar.project2(cash.paid = 0, invest.loan = 10000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 25,
                       install.fees = 3750, num.years = 20)

# Test using all default values, cash only
test5 <- solar.project2(cash.paid = 10000, invest.loan = 0, loan.apr = 0,
                       loan.length = 0, price.per.panel = 250, num.panels = 25,
                       install.fees = 3750, num.years = 20)
```

```{r plotting.distributed.input.ROI, include=F}
d.ROI <- ggplot(data = test4, aes(years, ROI)) +
    geom_abline(intercept = 0, slope = 0, col = "blue", linetype = 2) +
    geom_line() +
    labs(title = "Return on Investment (ROI) Over 15 Years for $10,000 Cash Project",
         x = "\nYears since initial investment") +
    theme_light()
d.ROI

d.ROI2 <- ggplot(data = test5, aes(years, ROI)) +
    geom_abline(intercept = 0, slope = 0, col = "blue", linetype = 2) +
    geom_line() +
    labs(title = "Return on Investment (ROI) Over 15 Years for $10,000 Loan Project",
         x = "\nYears since initial investment") +
    theme_light()
d.ROI2
```


## Introduction

Solar panels are all the rage these days. They have many benefits, from the environmental friendliness to the personal cost savings. For Iowans planning on residing at their home long-term, residential solar panels can be a wise investment. However, there are a lot of up-front expenses for solar array installation, in addition to the potential costs along the way. Solar panels are generally quite durable and come with lengthy warranties, but it can be difficult to take those potential costs into account.

There are countless websites that will provide solar project cost estimates, including installation costs and length before breaking even on the investment. However, these sites rarely provide any confidence intervals or margins of error. They also leave out details about how their estimates are calculated and what factors are being considered. Given the unpredictable aspects of being a solar array owner and utility customer, a model that takes variation into consideration may be useful. 

In this simulation, I set out to answer some questions about what one can expect from investing in a residential solar project in Iowa, whether taking out loans to invest in a solar project is an advantageous option, and how sensitive the outcome is to certain assumptions and expectations. For this study, I decided to exclude any state or federal incentives. This is intentional, as the Iowa program for residential solar project is severely backed up on requests and at risk of being curtailed or canceled. Therefore, Iowans should know what they can expect from a solar project without any government assistance or tax benefits.

-------------------------

## Methods

#### Inputs

To simulate a solar panel project, many inputs must be defined. Initial project costs related to the size of the project are considered first. We need to know the cash investment (which is considered the same as a down payment) in dollars, loan investment in dollars, APR (represented as a percent in decimal format) and loan length in years; the investment totals should then equal the installation fees plus the number of panels times the cost per panel. The user must also provide the solar panels' kilowatt hours per panel per month, which is calculated by multiplying the panel wattage times 5 hours per day times 30 days per month. Yearly costs include inspection and cleaning services, which are advised to be conducted annually. 

Next we need information about the panels' loss of efficiency over time, which occurs naturally due to aging and exposure. This is represented as an annual percent reduction in efficiency. There is also a probability that any number of the panels are damaged year-to-year; this input is annual probability of damage in decimal format. To study savings over time, we must know how much the user is charged per kilowatt hour (kWh) by their utility provider, as well as their typical monthly energy usage in kWh. Utility energy charges generally increase over time, so the function also requires an input for the percent annual change in price per kWh in decimal format. Finally, the last input is the number of years for which to run the simulation.

I created a two functions to simulate the solar project: one that utilizes static defaults based on my research about typical solar project costs in Iowa, and a second that models these inputs using distributions chosen based on the same research. While the first function can provide a model of what to expect from a solar project, it cannot provide any sort of variance estimate. However, the second function, when run a large number of times, provides a range of expected values that combines inputs from multiple sampled distributions.

#### Input defaults

Both functions have certain inputs that are required, with no defaults. Besides the number of years for which to run the simulation, all of the inputs are related to the size of the project: cash paid, loan investment, loan APR, loan length, number of panels, installation fees, and price per panel. All other inputs were given static defaults for the first version of the function and distributions for inputs in the second version.

The first default, kWh per panel, is one of only two that are static in both functions. The default for this input is set to 45, which corresponds to 300 watt panels getting an average of 5 hours of sun per day each month, a typical calculation for solar projects^[https://news.energysage.com/what-is-the-power-output-of-a-solar-panel/]. Although this can vary depending on the type of solar panels purchased, the wattage rating of the panels does not change over time, and thus is a static input for all scenarios. Similarly, the starting price per kWh charged by the utility company will be different depending on where you live, but that initial rate is also a static value. In this case, the starting price per kWh is set to 8.83 cents because that is the average price for Iowa City^[https://www.electricitylocal.com/states/iowa/iowa-city/].

The six remaining inputs have both static and distributed default values. See the histogram plots below for a visualization of the default distributions for these inputs (**Figure 1**). Starting with annual solar panel owner costs, there is significant room for variation in yearly fees. Standard advice is to budget $400 per year for solar panel inspection and maintenance^[https://www.fixr.com/costs/solar-panel-maintenance#:~:text=Solar%20Panel%20Cleaning%20Cost%20The%20average%20cost%20to,with%2010%20panels%2C%20expect%20to%20pay%20between%20%24150-%24330.], with a typical range given of \$150-\$1000 annually. In the second version of the function, I assigned this yearly costs variable a normal distribution with a mean of 400 and standard deviation of 50, so that most sampled values fell between \$300-500. 

Each year, there is some chance that the solar panels will be damaged. Although there is no readily available data on how common solar panel damage is, it is widely reported that solar panels are quite durable. Therefore I assigned the default for the annual probability of damage to be 0.5%, and for the distribution I assigned it a Bernoulli distribution (binomial with size=1) with $p=0.005$. In the case that the panels are damaged, there is an array of possible repairs needed. Based on online resources, I found that most solar panels repairs are relatively inexpensive, with a few more extreme cases costing much more^[https://www.fixr.com/costs/solar-panel-maintenance#solar-panel-repair-cost]. With this in mind, I set the default repair cost to \$2000 and assigned it an exponential distribution with a rate of $\lambda = 0.0005$. 

Over time, solar panels lose efficiency due to aging and exposure. However, this efficiency loss is generally quite low, and many solar panel producers will guarantee their panels to still produce 80% of their rated wattage after 20 years of use. Study estimates provide a typical annual efficiency loss range of 0.5-0.8%^[https://www.nrel.gov/docs/fy12osti/51664.pdf]. The function's default for annual efficiency loss is 0.5%, and its assigned distribution is normal with a mean of 0.0065 and a standard deviation of 0.001. 

Changes in price per kWh charged by the utility provider can make a significant difference in cost savings over time, as increases in price essentially add value to the solar panels. Looking at the history of energy prices in Iowa, it is clear that changes are anything but steady, with increases ranging from practically zero to 10% in a single year^[https://ballotpedia.org/Historical_state_electricity_prices]. Based on this history, the default change in price per kWh is set to 0.3% and is it given an exponential distribution with a rate of $\lambda = 50$. Finally, monthly energy usage is another factor with notable variance from month to month and year to year. Typical homes will use an average of 900 kWh per month, so this is the default value for the variable. In the second function, this variable is assigned a normal distribution with a mean of 900 and standard deviation of 200^[https://www.consumeraffairs.com/solar-energy/how-much-do-solar-panels-cost.html]. 

```{r define.input.distributions}
yearly.costs  <- rnorm(10000, mean=400, sd=50)
prop.effloss  <- rnorm(10000, mean=0.0065, sd=0.001)
prob.damage   <- rbinom(10000, size=1, prob=0.005)
repair.cost   <- rexp(10000, rate=0.0005) + 50
monthly.usage <- rnorm(10000, mean=900, sd=200)
ppkWh.change  <- rexp(10000, rate=50)

par(mfrow = c(2, 3))
hist(yearly.costs, main = "Histogram of Yearly Costs", xlab = "Yearly costs",
     col = "red")
hist(prop.effloss, main = "Histogram of Proportion \nof Efficiency Lost",
     xlab = "Proportion of Efficiency Lost Annually", col = "orange")
hist(repair.cost, main = "Histogram of Repair Costs", 
     xlab = "Cost of necessary panel repairs", col = "yellow")
hist(monthly.usage, main = "Histogram of Monthly \nEnergy Usage",
     xlab = "Monthly Energy Usage (kWh)", col = "green3")
hist(ppkWh.change, main = "Histogram of Annual Change \nin Price Per Killowatt Hour",
     xlab = "Change in Price Per kWh", col = "blue")
hist(prob.damage, main = "Histogram of Probability \nof Damage Occurring",
     xlab = "Probability of Damage to Panels", col = "purple", )
```

#### Function processes and simulations

Much of the operations within the solar project functions are rather intuitive. The function initializes a list of variables to track, including return on investment (ROI), net return, loan balance, amount saved, and other such factors necessary for calculating those figures. After performing some checks, assigning internal-use objects, and initializing tracking variables, the function moves on to its main procedure: the yearly updating of project details. In this loop that continues as many times as is specified in the function input, the function calculates loan principal and interest payments using a standard amortization schedule^[https://www.vertex42.com/ExcelArticles/amortization-calculation.html] and uses the inputs to track changes in panel efficiency, utility energy rates, costs due to damage, and its financial indicators. 

To do the simulations, I ran 10,000 solar projects for each individual scenario. I extracted the variables of interest from each project's outcome to compare. I started with a scenario for a \$10,000 project that would be expected to cover more than half of a household's monthly energy usage, and then moved to a \$15,000 project which would fully cover typical monthly energy usage for an Iowa residence. For both scenarios, I look at multiple financial metrics and compared funding the projects through cash (out-of-pocket) and loan investments.

Next, I wanted to test how sensitive the results were to assumptions made about certain input variables. For each of five input variables (efficiency loss, change in price per kWh, yearly costs, probability of damage, and monthly kWh per panel), I ran 10,000 simulations each for 5-6 different versions of the input variable. I was then able to plot these and find quantiles to address the question of sensitivity.

-------------------------

## Results

To begin with, we can see the results from the "point-estimate" version of the function that had static default values for the solar project. According to this model, someone investing in a solar project in Iowa can expect to break even on their investment at the 13 or 14 year mark, depending on whether they take out a loan to pursue the project. This is curiously lower than estimated on most websites, which usually estimate a break-even point of 10 years as a maximum. In **Figure 3**, you can clearly see the savings stack up over each year, even as the annual amount saved slightly decreases over time due to the loss of efficiency.

```{r plotting.static.input.ROI, fig.cap="Figure 2. ROI for typical $10k solar project in Iowa"}
single.ROI <- ggplot(data = test2, aes(years, ROI)) +
    geom_abline(intercept = 0, slope = 0, col = "blue", linetype = 2) +
    geom_line() +
    labs(title = "Return on Investment (ROI) Over 20 \nYears for $10k Cash Project",
         x = "\nYears since initial investment") +
    theme_light()

single.ROI2 <- ggplot(data = test1, aes(years, ROI)) +
    geom_abline(intercept = 0, slope = 0, col = "blue", linetype = 2) +
    geom_line() +
    labs(title = "Return on Investment (ROI) Over 20 \nYears for $10k Loan Project",
         x = "\nYears since initial investment") +
    theme_light()

ggarrange(single.ROI, single.ROI2, ncol = 2)
```

```{r plotting.static.input.net, fig.cap="Figure 3. Net return for typical $10k solar project in Iowa"}
single.net <- ggplot(data = test2, aes(years, net)) +
    geom_abline(intercept = 0, slope = 0, col = "blue", linetype = 2) +
    geom_line() +
    labs(title = "Net Return Over 20 Years \nfor $10k Cash Project",
         x = "\nYears since initial investment",
         y = "Net return") +
    theme_light()

single.net2 <- ggplot(data = test1, aes(years, net)) +
    geom_abline(intercept = 0, slope = 0, col = "blue", linetype = 2) +
    geom_line() +
    labs(title = "Net Return Over 20 Years \nfor $10k Loan Project",
         x = "\nYears since initial investment",
         y = "Net return") +
    theme_light()

ggarrange(single.net, single.net2, ncol = 2)
```

```{r plotting.static.input.moneysaved, fig.cap="Figure 4. Amount saved for typical $10k solar project in Iowa"}
single.ecosts <- ggplot(data = test2[-1,], aes(years, annual.amount.saved)) +
    geom_col(width = 1, color = "black", fill = "palegreen4") +
    scale_y_continuous(limits = c(0,1500)) +
    scale_fill_brewer(aes(years), palette = "Blues") +
    labs(title = "Annual Amount Saved on Energy Bill \nOver 20 Years for $10k Project",
         x = "\nYears since initial investment",
         y = "Annual energy cost paid to utility provider") +
    theme_light()

single.ecosts2 <- ggplot(data = test2[-1,], aes(years, gross.amount.saved)) +
    geom_col(width = 1, color = "black", fill = "palegreen4") +
    scale_y_continuous(limits = c(0,30000)) +
    labs(title = "Gross Amount Saved on Energy Bill \nOver 20 Years for $10k Project",
         x = "\nYears since initial investment",
         y = "Gross energy cost paid to utility provider") +
    theme_light()

ggarrange(single.ecosts, single.ecosts2, ncol = 2)

```

While interesting, these results do not provide more insight than that online sources may be too optimistic about the financial benefits of investing in solar panels. To better model these projects and account for their inherent unpredictability, we turn to the second version of the function with the distribution defaults. In first simulation, the same projects are compared but with attention to the variance in outcomes.

### Partial energy coverage project

The average Iowan undertaking a $10,000 solar panel project will not break even within the first 30 years. For the given inputs, 95% of Iowans paying cash for such a project would experience a return on investment of between -19.76% and 11.05% after 30 years, with a mean ROI of -4.58%. That corresponds to a net return between -\$4,995 and \$2,418 with a mean of -\$1,066. For the small proportion that do manage to break even with this type of project, the break even point should not be expected before 25 years after investing. This does not bode well for those interested in smaller residential solar projects. However, the tune changes when a slightly larger project is undertaken.

```{r 10k.project}
start <- Sys.time()
nsims <- 10000
sim.loan.ROIs <- rep(NA, nsims)
sim.cash.ROIs <- rep(NA, nsims)
sim.loan.nets <- rep(NA, nsims)
sim.cash.nets <- rep(NA, nsims)
loan.years.til.BE <- rep(NA, nsims)
cash.years.til.BE <- rep(NA, nsims)

for(i in 1:nsims) {
  proj <- solar.project2(cash.paid = 0, invest.loan = 10000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 12,
                       install.fees = 7000, num.years = 30)
  sim.loan.ROIs[[i]] <- proj$ROI[31]
  loan.years.til.BE[i] <- proj$years[which.max(proj$net >= 0)]
  sim.loan.nets[i] <- proj$net[31]
  
  proj <- solar.project2(cash.paid = 10000, invest.loan = 0, loan.apr = 0,
                       loan.length = 0, price.per.panel = 250, num.panels = 12,
                       install.fees = 7000, num.years = 30)
  sim.cash.ROIs[i] <- proj$ROI[31]
  cash.years.til.BE[i] <- proj$years[which.max(proj$net >= 0)]
  sim.cash.nets[i] <- proj$net[31]
}
end <- Sys.time()
print(end - start)
```

```{r 10k.project.ROI, fig.cap="Figure 5. Financial figures for $10k solar panel project in Iowa"}
## ROI
summary(sim.cash.ROIs)
quantile(sim.cash.ROIs, c(0.025, 0.975))
summary(sim.loan.ROIs)
quantile(sim.loan.ROIs, c(0.025, 0.975))

ROIs <- data.frame(investment.type = as.factor(c(rep("Cash", nsims), 
                                                 rep("Loan (5-year)", nsims))),
                      ROI = c(sim.cash.ROIs, sim.loan.ROIs))

simplot.ROI <- ggplot(data = ROIs, aes(investment.type, ROI)) +
  geom_violin(fill = "steelblue2", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Return on Investment (ROI)",
       x = NULL, y = "ROI") +
  theme_minimal()

## Net return
summary(sim.cash.nets)
quantile(sim.cash.nets, c(0.025, 0.975))
summary(sim.loan.nets)
quantile(sim.loan.nets, c(0.025, 0.975))

nets <- data.frame(investment.type = as.factor(c(rep("Cash", nsims), 
                                                 rep("Loan (5-year)", nsims))),
                   net = c(sim.cash.nets, sim.loan.nets))

simplot.net <- ggplot(data = nets, aes(investment.type, net)) +
  geom_violin(fill = "springgreen3", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Net Return",
       x = NULL, y = "Net return ($)") +
  theme_minimal()

## Break even point
summary(loan.years.til.BE)
quantile(loan.years.til.BE, c(0.025, 0.975))
summary(cash.years.til.BE)
quantile(cash.years.til.BE, c(0.025, 0.975))

BEs <- data.frame(investment.type = as.factor(c(rep("Cash", nsims), 
                                                rep("Loan (5-year)", nsims))),
                  BE = c(cash.years.til.BE, loan.years.til.BE))

simplot.BE <- ggplot(data = BEs, aes(investment.type, BE)) +
  geom_violin(fill = "tomato2", draw_quantiles = c(.5, 0.025, 0.975), bw = 0.5) +
  labs(title = "Years to Break Even",
       x = NULL, y = "Break even point") +
  theme_minimal()

ggarrange(simplot.ROI, simplot.net, simplot.BE, ncol = 3, 
          top = "30-Year Figures for $10k Solar Project by Investment Type",
          bottom = "Investment Type")
```

### Full energy coverage project

An additional \$5,000 in start-up money can make a huge difference. On average \$15,000 is what is takes to set up a residential solar panel system that covers 100% of the home's monthly energy usage. By switching to solar, the annual energy savings would allow for the average Iowan to break even at the 20-year mark for a cash-only project and at the 21-year mark for a loan-only project. For those who take on this project out of pocket, 95% would experience an ROI between 23.1% and 65.7% (\$6,720 - \$17,715 net return) after 30 years with an average ROI of 42.9% (\$11,654). 

For Iowans taking the loan route, 95% would experience an ROI between 16.5% and 56.4% (\$5,075 - \$16,053), averaging 35.3% (\$10,101) at 30 years. While there is a small chance to have bad luck and never break even, the probability of that happening is less than 0.1%, and 95% of people taking on projects like this will break even between 17 and 25 years after investing in the project.

```{r 15k.project, fig.cap="Figure 6. Financial figures for $15k solar panel project in Iowa"}
start <- Sys.time()
nsims <- 10000
sim.loan.ROIs <- rep(NA, nsims)
sim.cash.ROIs <- rep(NA, nsims)
sim.loan.nets <- rep(NA, nsims)
sim.cash.nets <- rep(NA, nsims)
loan.years.til.BE <- rep(NA, nsims)
cash.years.til.BE <- rep(NA, nsims)
end.change.ppkwh <- rep(NA, nsims)
end.change.eff <- rep(NA, nsims)
change.amount.saved <- rep(NA, nsims)

for(i in 1:nsims) {
  proj <- solar.project2(cash.paid = 0, invest.loan = 15000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 22,
                       install.fees = 9500, num.years = 30)
  sim.loan.ROIs[i] <- proj$ROI[31]
  sim.loan.nets[i] <- proj$net[31]
  loan.years.til.BE[i] <- proj$years[which.max(proj$net >= 0)]
  end.change.ppkwh[i] <- (proj$ppkWh[31] - proj$ppkWh[1]) / proj$ppkWh[1]
  end.change.eff[i] <- (1 - proj$panel.eff.capacity[31])
  
  proj <- solar.project2(cash.paid = 15000, invest.loan = 0, loan.apr = 0,
                       loan.length = 0, price.per.panel = 250, num.panels = 22,
                       install.fees = 9500, num.years = 30)
  sim.cash.ROIs[i] <- proj$ROI[31]
  sim.cash.nets[i] <- proj$net[31]
  change.amount.saved[i] <- (proj$annual.amount.saved[31] - proj$annual.amount.saved[2])
  cash.years.til.BE[i] <- proj$years[which.max(proj$net >= 0)]
}
end <- Sys.time()
print(end - start)

## ROI
summary(sim.cash.ROIs)
quantile(sim.cash.ROIs, c(0.025, 0.975))
summary(sim.loan.ROIs)
quantile(sim.loan.ROIs, c(0.025, 0.975))

ROIs <- data.frame(investment.type = as.factor(c(rep("Cash", nsims), 
                                                 rep("Loan (5-year)", nsims))),
                      ROI = c(sim.cash.ROIs, sim.loan.ROIs))

simplot.ROI <- ggplot(data = ROIs, aes(investment.type, ROI)) +
  geom_violin(fill = "steelblue2", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Return on Investment (ROI)",
       x = NULL, y = "ROI") +
  theme_minimal()

## Net return
summary(sim.cash.nets)
quantile(sim.cash.nets, c(0.025, 0.975))
summary(sim.loan.nets)
quantile(sim.loan.nets, c(0.025, 0.975))

nets <- data.frame(investment.type = as.factor(c(rep("Cash", nsims), 
                                                 rep("Loan (5-year)", nsims))),
                   net = c(sim.cash.nets, sim.loan.nets))

simplot.net <- ggplot(data = nets, aes(investment.type, net)) +
  geom_violin(fill = "springgreen3", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Net Return",
       x = NULL, y = "Net return ($)") +
  theme_minimal()

## Break even point
summary(loan.years.til.BE)
quantile(loan.years.til.BE, c(0.025, 0.975))
summary(cash.years.til.BE)
quantile(cash.years.til.BE, c(0.025, 0.975))

BEs <- data.frame(investment.type = as.factor(c(rep("Cash", nsims), 
                                                rep("Loan (5-year)", nsims))),
                  BE = c(cash.years.til.BE, loan.years.til.BE))

simplot.BE <- ggplot(data = BEs, aes(investment.type, BE)) +
  geom_violin(fill = "tomato2", draw_quantiles = c(.5, 0.025, 0.975), bw = 0.5) +
  labs(title = "Years to Break Even",
       x = NULL, y = "Break even point") +
  theme_minimal()

ggarrange(simplot.ROI, simplot.net, simplot.BE, ncol = 3, 
          top = "30-Year Figures for $15k Solar Project by Investment Type",
          bottom = "Investment Type")
```

These reported confidence intervals are possible because of the randomness embedded in the simulation function. They reflect the bad-, good-, and worst-case scenarios of taking on a residential solar project. In the next two figures (**Figures 7 and 8**), 100 of these individual projects are mapped out over the course of 30 years. Each project's corresponding ROI and net return is mapped on the y-axis. These figures illustrate how some projects go well and quickly pay themselves, while others face hurdles such as panel damages.

```{r 15k.project.ROI.animate, fig.cap="Figure 7. Progression of ROI for 100 $15k solar panel projects in Iowa"}
start <- Sys.time()
nsims <- 100
sim.small.ROIs <- list()
sim.small.nets <- list()

for(i in 1:nsims) {
  proj <- solar.project2(cash.paid = 5000, invest.loan = 10000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 22,
                       install.fees = 9500, num.years = 30)
  sim.small.ROIs[[i]] <- proj$ROI
  sim.small.nets[[i]] <- proj$net
}
end <- Sys.time()
print(end - start)

sim.animate <- data.frame(ROI = unlist(sim.small.ROIs),
                          Net = unlist(sim.small.nets),
                          Year = rep(seq(1, 31), times = nsims),
                          Rep = rep(seq(1, nsims), each = 31))

## ROI
simplot.ROI.a <- ggplot(sim.animate, aes(Year, ROI)) +
  geom_line(aes(group = Rep)) + 
  geom_abline(slope = 0, intercept = 0, color = "green4") +
  labs(title = "Expected ROI for $15k Mixed-Funding Solar Project Over 30 Years") +
  transition_states(Rep) +
  transition_reveal(Rep) + 
  transition_reveal(Year) +
  shadow_mark(color = "lightblue1", size = 0.25)
simplot.ROI.a

simplot.ROI.r <- ggplot(sim.animate, aes(Year, ROI)) +
  geom_line(size = 0.25) + 
  labs(title = "Expected ROI for $15k Mixed-Funding Solar Project Over 30 Years") +
  theme_minimal()
simplot.ROI.r
```

```{r 15k.project.net.animate, fig.cap="Figure 8. Progression of net return for 100 $15k solar panel projects in Iowa"}
## Net return
simplot.net.a <- ggplot(sim.animate, aes(Year, Net)) +
  geom_line(aes(group = Rep)) + 
  labs(title = "Expected net return for $15k Mixed-Funding Solar Project Over 30 Years") +
  transition_states(Rep) +
  transition_reveal(Rep) + 
  transition_reveal(Year) +
  shadow_mark(color = "palegreen", size = 0.25)
simplot.net.a

simplot.net.r <- ggplot(sim.animate, aes(Year, Net)) +
  geom_line() + 
  labs(title = "Expected net return for $15k Mixed-Funding Solar Project Over 30 Years") +
  theme_minimal()
simplot.net.r

```

### Sensitivity Analysis

Although this is a more optimistic picture than the \$10,000 project option, it still is a far less sunny picture than what most online sources put forth. It can be impossible to tell what sorts of inputs these online calculators are including, let alone any information about how those input values are determined. To understand how these financial outcomes may change under different circumstances, consider the following figures. 

#### *Panel efficiency loss*

From **Figure 9** it is clear that decreasing or increasing the annual percent efficiency loss has a corresponding effect on the financial figures, but this effect is not particularly drastic. Even if the panels lost an average of 1% efficiency per year, well above the estimated loss rate, the break even year would only be pushed back by a year or two. Overall, this is a factor for which the default parameter does not make a largely meaningful difference.

```{r sensitivity.analysis.effloss, fig.cap="Figure 9. Sensitivity of solar project to panel efficiency loss."}
start <- Sys.time()
props <- c(0.002, 0.005, 0.0065, 0.008, 0.01)
nsims <- 10000
sim.ROIs <- rep(NA, nsims*length(props))
sim.nets <- rep(NA, nsims*length(props))
sim.years.til.BE <- rep(NA, nsims*length(props))

for(j in 1:length(props)) {

for(i in 1:nsims) {
  proj <- solar.project2(cash.paid = 5000, invest.loan = 10000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 22,
                       install.fees = 9500, num.years = 30, 
                       prop.effloss = rnorm(31, mean = props[j], sd = 0.001))
  sim.ROIs[i + (10000 * (j - 1))] <- proj$ROI[31]
  sim.nets[i + (10000 * (j - 1))] <- proj$net[31]
  sim.years.til.BE[i + (10000 * (j - 1))] <- proj$years[which.max(proj$net >= 0)]
} # End simulation loop
  
} # End proportion efficiency loss loop

end <- Sys.time()
print(end - start)

## ROI
summary(sim.ROIs)
quantile(sim.ROIs, c(0.025, 0.975))

eff.ROIs <- data.frame(props = as.factor(rep(props, each = nsims)),
                       ROI = sim.ROIs)

eff.simplot.ROI <- ggplot(data = eff.ROIs, aes(props, ROI)) +
  geom_violin(fill = "steelblue2", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Return on Investment (ROI)",
       x = NULL, y = "ROI") +
  theme_minimal()

## Net return
summary(sim.nets)
quantile(sim.nets, c(0.025, 0.975))

eff.nets <- data.frame(props = as.factor(rep(props, each = nsims)),
                       net = sim.nets)

eff.simplot.net <- ggplot(data = eff.nets, aes(props, net)) +
  geom_violin(fill = "springgreen3", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Net Return",
       x = NULL, y = "Net return ($)") +
  theme_minimal()

## Break even point
summary(sim.years.til.BE)
quantile(sim.years.til.BE, c(0.025, 0.975))

eff.BEs <- data.frame(props = as.factor(rep(props, each = nsims)),
                      BE = sim.years.til.BE)

eff.simplot.BE <- ggplot(data = eff.BEs, aes(props, BE)) +
  geom_violin(fill = "tomato2", draw_quantiles = c(.5, 0.025, 0.975), bw = 0.5) +
  labs(title = "Years to Break Even",
       x = NULL, y = "Break even point") +
  theme_minimal()

ggarrange(eff.simplot.ROI, eff.simplot.net, eff.simplot.BE, ncol = 3, 
          top = "30-Year Figures for $15k Mixed Funding Solar Project by Mean Annual Percent Efficiency Loss",
          bottom = "Mean Annual Percent Efficiency Loss")
```

#### *Change in utility prices*

A very unpredictable factor in this solar project simulation study is how much the price per kWh charged by utility providers will change over the next decades. The annual change figure may remain quite small, as it has in Iowa for the past decade, or it may increase dramatically as natural energy resources are used up. To test the projects' sensitivity to this factor, six different rate parameters (20, 30, 40, 50, 60, and 70) were chosen for the factor's exponential distribution. The exponential distribution fits well because, in any given year, the utility company is more likely to increase prices by a smaller percentage than a large one. 

Before looking at the effects of these varying rates, it is helpful to visualize what these parameters look like for the exponential distribution. Note in **Figure 10** that when the parameter $\lambda = 20$, most annual percent increases are between 0% and 20%. This is scenario with quite dramatic energy price increases. On the other hand, when $\lambda = 70$, most annual percent increases are between 0% and 5%, which is more in line with the past decade of energy price changes in Iowa. Keep in mind that the lower parameter value corresponds to a higher rate of price increases.

```{r example.exp.distributions, fig.cap="Figure 10. Change in price per kWh distribution with range of parameter values"}
ppkWh.change1 <- rexp(10000, rate=20)
ppkWh.change2 <- rexp(10000, rate=30)
ppkWh.change3 <- rexp(10000, rate=40)
ppkWh.change4 <- rexp(10000, rate=50)
ppkWh.change5 <- rexp(10000, rate=60)
ppkWh.change6 <- rexp(10000, rate=70)

par(mfrow = c(2, 3))
hist(ppkWh.change1, main = NULL, xlab = "% increase in $/kWh (lambda=20)", col = "palegreen1")
hist(ppkWh.change2, main = "Histogram of Annual Change \nin Price Per Killowatt Hour",
     xlab = "% increase in $/kWh (lambda=30)", col = "palegreen2")
hist(ppkWh.change3, main = NULL, xlab = "% increase in $/kWh (lambda=40)", col = "palegreen3")
hist(ppkWh.change4, main = NULL, xlab = "% increase in $/kWh (lambda=50)", col = "palegreen4")
hist(ppkWh.change5, main = NULL, xlab = "% increase in $/kWh (lambda=60)", col = "forestgreen")
hist(ppkWh.change6, main = NULL, xlab = "% increase in $/kWh (lambda=70)", col = "darkgreen")
```

Immediately visible is the potential for ROI to be very large when the price of energy increases more quickly. When the rate is set to 50, the upper 95% bound for ROI is 59.1%, but when the rate is set to 20, the upper 95% bound for ROI is 232.1%. Increasing the parameter (decreasing the price increase rate) decreases ROI and net return to point, but towards the right side of the figure the outcomes distributions are squashed. This is because as the rate of price increases gets lower, the future prices are more predictable and closer to the current price. Therefore, these are more similar to calculating the same amount saved each year of owning the panels. Again, it is notable that the changes in this parameter value do not move the majority of the distributions below the break-even line.

```{r sensitivity.analysis.changeppkwh, fig.cap="Figure 11. Sensitivity of solar project to rates of changes in price per kWh"}
start <- Sys.time()
rates <- c(20, 30, 40, 50, 60, 70)
nsims <- 10000
sim.ROIs <- rep(NA, nsims*length(rates))
sim.nets <- rep(NA, nsims*length(rates))
sim.years.til.BE <- rep(NA, nsims*length(rates))

for(j in 1:length(rates)) {

for(i in 1:nsims) {
  proj <- solar.project2(cash.paid = 5000, invest.loan = 10000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 22,
                       install.fees = 9500, num.years = 30, 
                       ppkWh.change = rexp(31, rate = rates[j]))
  sim.ROIs[i + (10000 * (j - 1))] <- proj$ROI[31]
  sim.nets[i + (10000 * (j - 1))] <- proj$net[31]
  sim.years.til.BE[i + (10000 * (j - 1))] <- proj$years[which.max(proj$net >= 0)]
} # End simulation loop
  
} # End energy price increase rate loop

end <- Sys.time()
print(end - start)

## ROI
summary(sim.ROIs)
quantile(sim.ROIs, c(0.025, 0.975))

drate.ROIs <- data.frame(rates = as.factor(rep(rates, each = nsims)),
                       ROI = sim.ROIs)

drate.simplot.ROI <- ggplot(data = drate.ROIs, aes(rates, ROI)) +
  geom_violin(fill = "steelblue2", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Return on Investment (ROI)",
       x = NULL, y = "ROI") +
  theme_minimal()

## Net return
summary(sim.nets)
quantile(sim.nets, c(0.025, 0.975))

drate.nets <- data.frame(rates = as.factor(rep(rates, each = nsims)),
                       net = sim.nets)

drate.simplot.net <- ggplot(data = drate.nets, aes(rates, net)) +
  geom_violin(fill = "springgreen3", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Net Return",
       x = NULL, y = "Net return ($)") +
  theme_minimal()

## Break even point
summary(sim.years.til.BE)
quantile(sim.years.til.BE, c(0.025, 0.975))

drate.BEs <- data.frame(rates = as.factor(rep(rates, each = nsims)),
                      BE = sim.years.til.BE)

drate.simplot.BE <- ggplot(data = drate.BEs, aes(rates, BE)) +
  geom_violin(fill = "tomato2", draw_quantiles = c(.5, 0.025, 0.975), bw = 0.5) +
  labs(title = "Years to Break Even",
       x = NULL, y = "Break even point") +
  theme_minimal()

ggarrange(drate.simplot.ROI, drate.simplot.net, drate.simplot.BE, ncol = 3, 
          top = "30-Year Figures for $15k Mixed Funding Solar Project by Rate of Energy Price Increase",
          bottom = "Rate of Energy Price Increase \n(exponential distibution lambda parameter)")
```

#### *Yearly inspection and cleaning costs*

Perhaps unsurprisingly, the yearly costs factor, which accounts for inspection and cleaning costs, is highly influential of the financial outcome for the solar project. For Iowans with the technical know-how and willingness to inspect and clean their solar panels themselves, a $0 yearly cost will result in a 30-year net return of \$17,736 - \$28,564 95% of the time. Spending the reportedly average \$400 per year on inspection and cleaning will decrease the expected 30-year net return by around \$12,000. If inspection and cleaning costs are high for a solar panel owner, and they pay an average of \$800 per year on those services, their expected ROI after 30 years dips below 0 and the probability of breaking even on the project by that point is only 28.7%. 

```{r sensitivity.analysis.costs, fig.cap="Figure 12. Sensitivity of solar project to annual service costs"}
start <- Sys.time()
costs <- c(0, 200, 400, 600, 800)
nsims <- 10000
sim.ROIs <- rep(NA, nsims*length(costs))
sim.nets <- rep(NA, nsims*length(costs))
sim.years.til.BE <- rep(NA, nsims*length(costs))

for(j in 1:length(costs)) {

for(i in 1:nsims) {
  proj <- solar.project2(cash.paid = 5000, invest.loan = 10000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 22,
                       install.fees = 9500, num.years = 30, 
                       yearly.costs = rnorm(31, mean = costs[j], sd = 50))
  sim.ROIs[i + (10000 * (j - 1))] <- proj$ROI[31]
  sim.nets[i + (10000 * (j - 1))] <- proj$net[31]
  sim.years.til.BE[i + (10000 * (j - 1))] <- proj$years[which.max(proj$net >= 0)]
} # End simulation loop
  
} # End energy price increase rate loop

end <- Sys.time()
print(end - start)

## ROI
summary(sim.ROIs)
quantile(sim.ROIs, c(0.025, 0.975))

costs.ROIs <- data.frame(costs = as.factor(rep(costs, each = nsims)),
                       ROI = sim.ROIs)

costs.simplot.ROI <- ggplot(data = costs.ROIs, aes(costs, ROI)) +
  geom_violin(fill = "steelblue2", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Return on Investment (ROI)",
       x = NULL, y = "ROI") +
  theme_minimal()

## Net return
summary(sim.nets)
quantile(sim.nets, c(0.025, 0.975))

costs.nets <- data.frame(costs = as.factor(rep(costs, each = nsims)),
                       net = sim.nets)

costs.simplot.net <- ggplot(data = costs.nets, aes(costs, net)) +
  geom_violin(fill = "springgreen3", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Net Return",
       x = NULL, y = "Net return ($)") +
  theme_minimal()

## Break even point
summary(sim.years.til.BE)
quantile(sim.years.til.BE, c(0.025, 0.975))

costs.BEs <- data.frame(costs = as.factor(rep(costs, each = nsims)),
                        BE = sim.years.til.BE)

costs.simplot.BE <- ggplot(data = costs.BEs, aes(costs, BE)) +
  geom_violin(fill = "tomato2", draw_quantiles = c(.5, 0.025, 0.975), bw = 0.5) +
  labs(title = "Years to Break Even",
       x = NULL, y = "Break even point") +
  theme_minimal()

ggarrange(costs.simplot.ROI, costs.simplot.net, costs.simplot.BE, ncol = 3, 
          top = "30-Year Figures for $15k Mixed Funding Solar Project by Expected Yearly Costs",
          bottom = "Mean Annual Costs \n(normal distibution mu parameter)")
```

#### *Probability of system damage*

Another highly variable factor when it comes to owning solar panels is the probability of experiencing damage to the system. Despite their general durability, solar panels are not immune to the various events that wreak havoc on households. This is particularly true in Iowa, where tornadoes, blizzards, hail storms, and even derechos (wind storms) can come when least expected. Although repair costs may set back solar panel owners in some years, the good news is that such costs are unlikely to completely derail a project in the long run. In a worst case scenario where heavy solar panel damage is occurring once every 5 years, the probability of breaking even on the project after 30 years dips down close to 50%. This seems unlikely, though, so for the most part the project outcome is not highly influenced by the assumed probability of damage.

```{r sensitivity.analysis.pdamage, fig.cap="Figure 13. Sensitivity of solar project to probability of system damage"}
start <- Sys.time()
pdamages <- c(0.001, 0.005, 0.01, 0.05, 0.10, 0.2)
nsims <- 10000
sim.ROIs <- rep(NA, nsims*length(pdamages))
sim.nets <- rep(NA, nsims*length(pdamages))
sim.years.til.BE <- rep(NA, nsims*length(pdamages))

for(j in 1:length(pdamages)) {

for(i in 1:nsims) {
  proj <- solar.project2(cash.paid = 5000, invest.loan = 10000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 22,
                       install.fees = 9500, num.years = 30, 
                       prob.damage = rbinom(31, size = 1, prob = pdamages[j]))
  sim.ROIs[i + (10000 * (j - 1))] <- proj$ROI[31]
  sim.nets[i + (10000 * (j - 1))] <- proj$net[31]
  sim.years.til.BE[i + (10000 * (j - 1))] <- proj$years[which.max(proj$net >= 0)]
} # End simulation loop
  
} # End energy price increase rate loop

end <- Sys.time()
print(end - start)

## ROI
summary(sim.ROIs)
quantile(sim.ROIs, c(0.025, 0.975))

pdamages.ROIs <- data.frame(pdamages = as.factor(rep(pdamages, each = nsims)),
                       ROI = sim.ROIs)

pdamages.simplot.ROI <- ggplot(data = pdamages.ROIs, aes(pdamages, ROI)) +
  geom_violin(fill = "steelblue2", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Return on Investment (ROI)",
       x = NULL, y = "ROI") +
  theme_minimal()

## Net return
summary(sim.nets)
quantile(sim.nets, c(0.025, 0.975))

pdamages.nets <- data.frame(pdamages = as.factor(rep(pdamages, each = nsims)),
                       net = sim.nets)

pdamages.simplot.net <- ggplot(data = pdamages.nets, aes(pdamages, net)) +
  geom_violin(fill = "springgreen3", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Net Return",
       x = NULL, y = "Net return ($)") +
  theme_minimal()

## Break even point
summary(sim.years.til.BE)
quantile(sim.years.til.BE, c(0.025, 0.975))

pdamages.BEs <- data.frame(pdamages = as.factor(rep(pdamages, each = nsims)),
                        BE = sim.years.til.BE)

pdamages.simplot.BE <- ggplot(data = pdamages.BEs, aes(pdamages, BE)) +
  geom_violin(fill = "tomato2", draw_quantiles = c(.5, 0.025, 0.975), bw = 0.5) +
  labs(title = "Years to Break Even",
       x = NULL, y = "Break even point") +
  theme_minimal()

ggarrange(pdamages.simplot.ROI, pdamages.simplot.net, pdamages.simplot.BE, ncol = 3, 
          top = "30-Year Figures for $15k Mixed Funding Solar Project by Probability of Damage Occurring",
          bottom = "Yearly Probability of Damage \n(binomial distibution p parameter)")
```

#### *Panel wattage*

Websites about solar panel projects throw around various figures like "300 watts", "6.0 kW systems", and "$2.50 per watt," and yet the calculator will give you one simple number for number of years before breaking even or amount saved. Despite the implication that any solar panel array will pay itself off, **Figure 14** indicates how greatly the quality of the panel purchased can affect the financial outcomes of a solar project. 

The U.S. Department of Energy reports that most panels on the market have rated wattages between 250-400, which corresponds to 37.5-60 kWh per month per panel. The function default of 45 kWh per month per panel represents 300 watt panels, comfortably within the standard margin. This range is more extreme than it appears, though. By spending their money on lower-end panels rated at 250 watts (37.5 kWh), 95% of Iowans would experience an ROI between -0.6% and 33.1% by year 30. Conversely, going with high-end panels rated at 400 watts (60 kWh) would result in a 30-year ROI between 58.7% and 113.6% in 95% of cases. This represents an average difference in net return of $19,513.

```{r sensitivity.analysis.panelquality, fig.cap="Figure 14. Sensitivity of solar project to quality of panels purchased"}
start <- Sys.time()
watts <- c(37.5, 45, 52.5, 60, 67.5)
nsims <- 10000
sim.ROIs <- rep(NA, nsims*length(watts))
sim.nets <- rep(NA, nsims*length(watts))
sim.years.til.BE <- rep(NA, nsims*length(watts))

for(j in 1:length(watts)) {

for(i in 1:nsims) {
  proj <- solar.project2(cash.paid = 5000, invest.loan = 10000, loan.apr = .032,
                       loan.length = 5, price.per.panel = 250, num.panels = 22,
                       install.fees = 9500, num.years = 30, 
                       kWh.per.panel = watts[j])
  sim.ROIs[i + (10000 * (j - 1))] <- proj$ROI[31]
  sim.nets[i + (10000 * (j - 1))] <- proj$net[31]
  sim.years.til.BE[i + (10000 * (j - 1))] <- proj$years[which.max(proj$net >= 0)]
} # End simulation loop
  
} # End panel kWh per month loop

end <- Sys.time()
print(end - start)

## ROI
summary(sim.ROIs)
quantile(sim.ROIs, c(0.025, 0.975))

watts.ROIs <- data.frame(watts = as.factor(rep(watts, each = nsims)),
                       ROI = sim.ROIs)

watts.simplot.ROI <- ggplot(data = watts.ROIs, aes(watts, ROI)) +
  geom_violin(fill = "steelblue2", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Return on Investment (ROI)",
       x = NULL, y = "ROI") +
  theme_minimal()

## Net return
summary(sim.nets)
quantile(sim.nets, c(0.025, 0.975))

watts.nets <- data.frame(watts = as.factor(rep(watts, each = nsims)),
                       net = sim.nets)

watts.simplot.net <- ggplot(data = watts.nets, aes(watts, net)) +
  geom_violin(fill = "springgreen3", draw_quantiles = c(.5, 0.025, 0.975)) +
  labs(title = "Net Return",
       x = NULL, y = "Net return ($)") +
  theme_minimal()

## Break even point
summary(sim.years.til.BE)
quantile(sim.years.til.BE, c(0.025, 0.975))

watts.BEs <- data.frame(watts = as.factor(rep(watts, each = nsims)),
                        BE = sim.years.til.BE)

watts.simplot.BE <- ggplot(data = watts.BEs, aes(watts, BE)) +
  geom_violin(fill = "tomato2", draw_quantiles = c(.5, 0.025, 0.975), bw = 0.5) +
  labs(title = "Years to Break Even",
       x = NULL, y = "Break even point") +
  theme_minimal()

ggarrange(watts.simplot.ROI, watts.simplot.net, watts.simplot.BE, ncol = 3, 
          top = "30-Year Figures for $15k Mixed Funding Solar Project by Panel Wattage",
          bottom = "Quality of panel in kWh per month")
```


-------------------------

## Conclusions and Future Work

It is clear from this simulation study's results that the finances of solar panel projects are less cut and dry than they appear online. Surprisingly, installing a small solar panel array (and paying to maintain it each year) may not save enough money on energy bills to make back the investment. Although purchasing a full solar array does appear to be a smart financial investment in the long run, the point at which one might see a return on that investment may be much later than some institutions and websites purport.

When considering whether to invest in a residential solar project, it is clear that going with a system that will cover all expected energy usage is advantageous. Additionally, potential project-undertakers should very intentionally consider what type of solar panels they are selecting and what amount of maintenance they will put into their system. These factors are particularly influential on the financial outcome of the project.

Overall, there is no small degree of uncertainty when taking on such a project. With many unpredictable factors, a money-saving project can easily become a money sink instead. Given the same conditions as specified in the models above, with moderate yearly maintenance and mid-range 300W solar panels, Iowans spending \$15,000 on a solar project can expect to break even in 17-25 years. Keep in mind that this range is highly subject to the stated conditions. Given the right circumstances, a solar panel project may be a very sound financial investment.

As stated earlier, this simulation does not take into account any sort of government tax breaks or assistance. Including government assistance would likely drive down costs considerably and make solar project investments much more advantageous. A future version of this model would include inputs for government assistance and tax incentives. Another factor that is left out of this simulation entirely is the environmental impact of energy usage. One great benefit of solar panels is the fact that they are environmentally friendly. This could be an interesting component for this simulation to include in the future.

Finally, this model does not perfectly represent the year-to-year costs associated with solar projects. While adding too many inputs may make the simulation overly detailed, some more refinement could improve its results. There are details related to damage type, possibilities around paying off loans, month-to-month changes, and more that could be included. This model takes account of major aspects of the solar project process, but it is limited in these ways.


-------------------------

## Appendix

Link to code on GitHub: https://github.com/smfinn/solar 
